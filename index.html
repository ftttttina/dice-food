<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DESTINY - COLLISION PRO</title>
  <style>
    :root { --bg: #000; --light-x: 50%; --light-y: 50%; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: "SF Pro Display", sans-serif; color: #fff; }

    /* 牆壁閃爍效果 (iPhone 震動補償) */
    #flash { position: absolute; width: 100%; height: 100%; background: #fff; opacity: 0; z-index: 99; pointer-events: none; }

    #ambient {
      position: absolute; width: 100%; height: 100%;
      background: radial-gradient(circle at var(--light-x) var(--light-y), rgba(255,255,255,0.12) 0%, transparent 60%),
                  radial-gradient(circle at 50% 50%, #161618 0%, #000 85%);
      z-index: 1; pointer-events: none;
    }

    .header { position: absolute; top: 6vh; width: 100%; text-align: center; z-index: 100; pointer-events: none; }
    h1 { font-weight: 200; font-size: 0.9rem; letter-spacing: 12px; margin: 0; opacity: 0.9; }

    /* 進度條 */
    #progress-wrap { position: absolute; top: 15vh; width: 100%; display: flex; justify-content: center; opacity: 0; transition: 0.5s; z-index: 100; }
    #progress-bar { width: 100px; height: 2px; background: rgba(255,255,255,0.1); overflow: hidden; }
    #progress-inner { width: 0%; height: 100%; background: #fff; }

    #world { position: absolute; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
    .dice-obj { position: absolute; width: 62px; height: 62px; perspective: 1000px; left:0; top:0; }
    .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.1s linear; }
    .cube div {
      position: absolute; width: 62px; height: 62px; background: rgba(255,255,255,0.06);
      backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.15); border-radius: 14px;
      display: grid; padding: 10px; box-sizing: border-box;
    }
    .dot { width: 10px; height: 10px; background: #fff; border-radius: 50%; align-self: center; justify-self: center; box-shadow: 0 0 10px #fff; }

    /* 3D 面定義... (與之前相同) */
    .f1 { transform: rotateY(0deg) translateZ(31px); } .f6 { transform: rotateY(180deg) translateZ(31px); }
    .f2 { transform: rotateX(90deg) translateZ(31px); } .f5 { transform: rotateX(-90deg) translateZ(31px); }
    .f3 { transform: rotateY(90deg) translateZ(31px); } .f4 { transform: rotateY(-90deg) translateZ(31px); }

    .result-container { position: absolute; top: 40%; width: 100%; text-align: center; z-index: 50; pointer-events: none; }
    #food-cn { font-size: 2.2rem; font-weight: 200; letter-spacing: 8px; margin: 0; opacity: 0; transition: 1s; }
    #food-en { font-size: 0.7rem; opacity: 0; margin-top: 10px; letter-spacing: 4px; text-transform: uppercase; color: rgba(255,255,255,0.4); }

    .controls { position: absolute; bottom: 8vh; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 101; }
    .btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px 28px; border-radius: 40px; cursor: pointer; backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; min-width: 120px; }
  </style>
</head>
<body>

<div id="flash"></div>
<div id="ambient"></div>

<div class="header">
  <h1>命定全餐</h1>
  <div id="progress-wrap"><div id="progress-bar"><div id="progress-inner"></div></div></div>
</div>

<div id="world">
  <div id="d1" class="dice-obj"><div class="cube" id="c1">
    <div class="f1"><span class="dot"></span></div>
    <div class="f6" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    <div class="f2" style="display:flex; justify-content:space-between;"><span class="dot"></span><span class="dot"></span></div>
    <div class="f5" style="display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot" style="grid-area:2/2"></span></div>
    <div class="f3" style="display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot" style="grid-area:1/1"></span><span class="dot" style="grid-area:2/2"></span><span class="dot" style="grid-area:3/3"></span></div>
    <div class="f4" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
  </div></div>
  <div id="d2" class="dice-obj"><div class="cube" id="c2">
    <div class="f1"><span class="dot"></span></div>
    <div class="f6" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    <div class="f2" style="display:flex; justify-content:space-between;"><span class="dot"></span><span class="dot"></span></div>
    <div class="f5" style="display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot" style="grid-area:2/2"></span></div>
    <div class="f3" style="display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot" style="grid-area:1/1"></span><span class="dot" style="grid-area:2/2"></span><span class="dot" style="grid-area:3/3"></span></div>
    <div class="f4" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
  </div></div>
</div>

<div class="result-container">
  <h2 id="food-cn"></h2>
  <div id="food-en"></div>
</div>

<div class="controls">
  <button class="btn" onclick="shake()"><span>擲骰 / SHAKE</span></button>
  <button class="btn" id="motionBtn" onclick="toggleMotion()"><span>體感 / MOTION</span></button>
</div>

<script>
  let dice = [
    { el: document.getElementById('d1'), c: document.getElementById('c1'), x: 80, y: 300, vx: 0, vy: 0, rx: 0, ry: 0, rad: 31 },
    { el: document.getElementById('d2'), c: document.getElementById('c2'), x: 220, y: 350, vx: 0, vy: 0, rx: 0, ry: 0, rad: 31 }
  ];

  let useMotion = false, gX = 0, gY = 0, isRolling = false;
  const bounce = 0.7, friction = 0.98;

  function visualVibrate() {
    const f = document.getElementById('flash');
    f.style.opacity = "0.15";
    setTimeout(() => f.style.opacity = "0", 40);
  }

  function shake() {
    isRolling = true;
    document.getElementById('food-cn').style.opacity = 0;
    document.getElementById('progress-wrap').style.opacity = 1;
    dice.forEach(d => { d.vx += (Math.random()-0.5)*70; d.vy += (Math.random()-0.5)*70; });
  }

  function toggleMotion() {
    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission().then(s => { if(s==='granted') startMotion(); });
    } else { startMotion(); }
  }

  function startMotion() {
    useMotion = true;
    document.getElementById('motionBtn').style.background = "#fff";
    document.getElementById('motionBtn').style.color = "#000";
    window.addEventListener('deviceorientation', e => { if(useMotion){ gX = e.gamma/12; gY = e.beta/12; } });
  }

  function update() {
    let energy = 0;
    
    // 1. 處理物體間碰撞 (防止重疊)
    let dx = dice[1].x - dice[0].x;
    let dy = dice[1].y - dice[0].y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    let minDist = dice[0].rad + dice[1].rad;
    
    if (dist < minDist) {
      let angle = Math.atan2(dy, dx);
      let tx = dice[0].x + Math.cos(angle) * minDist;
      let ty = dice[0].y + Math.sin(angle) * minDist;
      let ax = (tx - dice[1].x) * 0.5;
      let ay = (ty - dice[1].y) * 0.5;
      dice[0].vx -= ax; dice[0].vy -= ay;
      dice[1].vx += ax; dice[1].vy += ay;
    }

    // 2. 處理牆壁碰撞與移動
    dice.forEach(d => {
      d.vx += gX; d.vy += gY;
      d.vx *= friction; d.vy *= friction;
      d.x += d.vx; d.y += d.vy;

      if(d.x < 0 || d.x > window.innerWidth-62) { 
        d.vx *= -bounce; d.x = d.x<0?0:window.innerWidth-62; 
        if(Math.abs(d.vx)>5) visualVibrate();
      }
      if(d.y < 0 || d.y > window.innerHeight-62) { 
        d.vy *= -bounce; d.y = d.y<0?0:window.innerHeight-62; 
        if(Math.abs(d.vy)>5) visualVibrate();
      }

      d.rx += d.vy * 3; d.ry += d.vx * 3;
      d.el.style.transform = `translate3d(${d.x}px, ${d.y}px, 0)`;
      d.c.style.transform = `rotateX(${d.rx}deg) rotateY(${d.ry}deg)`;
      energy += Math.abs(d.vx) + Math.abs(d.vy);
    });

    // 3. 更新進度條
    if(isRolling) {
      let prog = Math.min(100, energy * 2);
      document.getElementById('progress-inner').style.width = prog + "%";
      if (energy < 0.4) { isRolling = false; showResult(); }
    }

    requestAnimationFrame(update);
  }

  function showResult() {
    document.getElementById('progress-wrap').style.opacity = 0;
    document.getElementById('food-cn').innerText = "深夜拉麵";
    document.getElementById('food-en').innerText = "MIDNIGHT RAMEN";
    document.getElementById('food-cn').style.opacity = 1;
    document.getElementById('food-en').style.opacity = 1;
    visualVibrate(); // 揭曉瞬間閃爍
  }

  update();
</script>
</body>
</html>
