<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DESTINY - STABLE PHYSICS</title>
  <style>
    :root { --bg: #000; --light-x: 50%; --light-y: 50%; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: "SF Pro Display", -apple-system, sans-serif; color: #fff; }

    #ambient {
      position: absolute; width: 100%; height: 100%;
      background: radial-gradient(circle at var(--light-x) var(--light-y), rgba(255,255,255,0.1) 0%, transparent 60%),
                  radial-gradient(circle at 50% 50%, #121214 0%, #000 90%);
      z-index: 1; pointer-events: none;
    }

    .header { position: absolute; top: 8vh; width: 100%; text-align: center; z-index: 100; pointer-events: none; }
    h1 { font-weight: 200; font-size: 0.9rem; letter-spacing: 12px; margin: 0; opacity: 0.8; }
    .sub-title { font-size: 0.4rem; letter-spacing: 4px; opacity: 0.3; margin-top: 5px; text-transform: uppercase; }

    /* 能量/時間線條 */
    #timeline-wrap { position: absolute; top: 16vh; width: 100%; display: flex; justify-content: center; opacity: 0; transition: 0.5s; z-index: 100; }
    #timeline-bar { width: 80px; height: 1px; background: rgba(255,255,255,0.1); }
    #timeline-inner { width: 0%; height: 100%; background: #fff; transition: width 0.1s linear; }

    #world { position: absolute; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
    .dice-obj { position: absolute; width: 62px; height: 62px; perspective: 1000px; left:0; top:0; }
    .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
    .cube div {
      position: absolute; width: 62px; height: 62px; background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); border-radius: 14px;
      display: grid; padding: 10px; box-sizing: border-box;
    }
    .dot { width: 10px; height: 10px; background: #fff; border-radius: 50%; align-self: center; justify-self: center; box-shadow: 0 0 8px #fff; }

    .f1 { transform: rotateY(0deg) translateZ(31px); } .f6 { transform: rotateY(180deg) translateZ(31px); }
    .f2 { transform: rotateX(90deg) translateZ(31px); } .f5 { transform: rotateX(-90deg) translateZ(31px); }
    .f3 { transform: rotateY(90deg) translateZ(31px); } .f4 { transform: rotateY(-90deg) translateZ(31px); }

    .result-container { position: absolute; top: 40%; width: 100%; text-align: center; z-index: 50; pointer-events: none; }
    #food-cn { font-size: 2.2rem; font-weight: 200; letter-spacing: 8px; margin: 0; opacity: 0; transition: 1.2s cubic-bezier(0.19, 1, 0.22, 1); }
    #food-en { font-size: 0.7rem; opacity: 0; margin-top: 10px; letter-spacing: 4px; text-transform: uppercase; color: rgba(255,255,255,0.4); }

    .controls { position: absolute; bottom: 8vh; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 101; }
    .btn { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 12px 25px; border-radius: 40px; cursor: pointer; min-width: 120px; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
    .btn span:first-child { font-size: 0.7rem; letter-spacing: 2px; }
    .btn span:last-child { font-size: 0.35rem; opacity: 0.5; margin-top: 2px; }
    .btn.active { background: #fff; color: #000; }
  </style>
</head>
<body>

<div id="ambient"></div>

<div class="header">
  <h1>命定全餐</h1>
  <div class="sub-title">DESTINY DINNER</div>
  <div id="timeline-wrap"><div id="timeline-bar"><div id="timeline-inner"></div></div></div>
</div>

<div id="world">
  <div id="d1" class="dice-obj"><div class="cube" id="c1">
    <div class="f1"><span class="dot"></span></div>
    <div class="f6" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    <div class="f2" style="display:flex; justify-content:space-between;"><span class="dot"></span><span class="dot" style="align-self:flex-end"></span></div>
    <div class="f5" style="display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot" style="grid-area:2/2"></span></div>
    <div class="f3" style="display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot" style="grid-area:1/1"></span><span class="dot" style="grid-area:2/2"></span><span class="dot" style="grid-area:3/3"></span></div>
    <div class="f4" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
  </div></div>
  <div id="d2" class="dice-obj"><div class="cube" id="c2">
    <div class="f1"><span class="dot"></span></div>
    <div class="f6" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    <div class="f2" style="display:flex; justify-content:space-between;"><span class="dot"></span><span class="dot" style="align-self:flex-end"></span></div>
    <div class="f5" style="display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot" style="grid-area:2/2"></span></div>
    <div class="f3" style="display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr;"><span class="dot" style="grid-area:1/1"></span><span class="dot" style="grid-area:2/2"></span><span class="dot" style="grid-area:3/3"></span></div>
    <div class="f4" style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
  </div></div>
</div>

<div class="result-container">
  <h2 id="food-cn"></h2>
  <div id="food-en"></div>
</div>

<div class="controls">
  <button class="btn" onclick="shake()">
    <span>擲骰</span>
    <span>SHAKE</span>
  </button>
  <button class="btn" id="motionBtn" onclick="toggleMotion()">
    <span>體感模式: 關</span>
    <span>MOTION: OFF</span>
  </button>
</div>

<script>
  // 菜單庫
  const menu = {
    morning: [{cn: "酪梨吐司", en: "Avocado Toast"}, {cn: "日式飯糰", en: "Onigiri"}, {cn: "手沖咖啡", en: "Filter Coffee"}],
    noon: [{cn: "牛肉麵", en: "Beef Noodle"}, {cn: "海南雞飯", en: "Chicken Rice"}, {cn: "夏威夷碗", en: "Poke Bowl"}],
    evening: [{cn: "熟成牛排", en: "Aged Steak"}, {cn: "居酒屋", en: "Izakaya"}, {cn: "麻辣火鍋", en: "Spicy Pot"}],
    midnight: [{cn: "拉麵", en: "Ramen"}, {cn: "鹽酥雞", en: "Fried Chicken"}, {cn: "關東煮", en: "Oden"}]
  };

  let dice = [
    { el: document.getElementById('d1'), c: document.getElementById('c1'), x: 80, y: 300, vx: 0, vy: 0, rx: 0, ry: 0, rad: 31 },
    { el: document.getElementById('d2'), c: document.getElementById('c2'), x: 220, y: 350, vx: 0, vy: 0, rx: 0, ry: 0, rad: 31 }
  ];

  let useMotion = false, gX = 0, gY = 0, isRolling = false;
  let currentFriction = 0.98; // 標準摩擦力
  const bounce = 0.65;

  function shake() {
    isRolling = true;
    currentFriction = 0.98; 
    document.getElementById('food-cn').style.opacity = 0;
    document.getElementById('food-en').style.opacity = 0;
    document.getElementById('timeline-wrap').style.opacity = 1;
    dice.forEach(d => { d.vx += (Math.random()-0.5)*70; d.vy += (Math.random()-0.5)*70; });
  }

  function toggleMotion() {
    if (!useMotion) {
      if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(s => { if(s==='granted') startMotion(); });
      } else { startMotion(); }
    } else {
      useMotion = false; gX = 0; gY = 0;
      document.getElementById('motionBtn').classList.remove('active');
      document.getElementById('motionBtn').children[0].innerText = "體感模式: 關";
    }
  }

  function startMotion() {
    useMotion = true;
    document.getElementById('motionBtn').classList.add('active');
    document.getElementById('motionBtn').children[0].innerText = "體感模式: 開";
    window.addEventListener('deviceorientation', e => { 
      if(useMotion){ 
        gX = e.gamma/14; gY = e.beta/14; 
        if (Math.abs(gX) + Math.abs(gY) > 0.5) {
          isRolling = true;
          currentFriction = 0.98; // 動作大時保持低摩擦力
          document.getElementById('food-cn').style.opacity = 0;
        }
      }
    });
  }

  function update() {
    let energy = 0;
    
    // 1. 物理碰撞 (防止重疊)
    let dx = dice[1].x - dice[0].x;
    let dy = dice[1].y - dice[0].y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < 62) {
      let angle = Math.atan2(dy, dx);
      dice[0].vx -= Math.cos(angle) * 1.5;
      dice[0].vy -= Math.sin(angle) * 1.5;
      dice[1].vx += Math.cos(angle) * 1.5;
      dice[1].vy += Math.sin(angle) * 1.5;
    }

    // 2. 體感時間線機制：如果能量低，逐漸增加摩擦力直到停止
    if (isRolling && Math.abs(gX) + Math.abs(gY) < 0.3) {
      currentFriction *= 0.995; // 進入緩慢減速時間線
    }

    dice.forEach(d => {
      d.vx += gX; d.vy += gY;
      d.vx *= currentFriction; d.vy *= currentFriction;
      d.x += d.vx; d.y += d.vy;

      // 牆壁邊界
      if(d.x < 0 || d.x > window.innerWidth-62) { d.vx *= -bounce; d.x = d.x<0?0:window.innerWidth-62; }
      if(d.y < 0 || d.y > window.innerHeight-62) { d.vy *= -bounce; d.y = d.y<0?0:window.innerHeight-62; }

      d.rx += d.vy * 3; d.ry += d.vx * 3;
      d.el.style.transform = `translate3d(${d.x}px, ${d.y}px, 0)`;
      d.c.style.transform = `rotateX(${d.rx}deg) rotateY(${d.ry}deg)`;
      energy += Math.abs(d.vx) + Math.abs(d.vy);
    });

    // 動態光影
    document.body.style.setProperty('--light-x', `${(dice[0].x / window.innerWidth)*100}%`);
    document.body.style.setProperty('--light-y', `${(dice[0].y / window.innerHeight)*100}%`);

    // 能量條與停止判定
    if(isRolling) {
      document.getElementById('timeline-wrap').style.opacity = 1;
      document.getElementById('timeline-inner').style.width = Math.min(100, energy*2) + "%";
      if (energy < 0.2) { 
        isRolling = false; 
        showResult(); 
      }
    } else {
      document.getElementById('timeline-wrap').style.opacity = 0;
    }

    requestAnimationFrame(update);
  }

  function showResult() {
    const hr = new Date().getHours();
    let list = menu.evening;
    if(hr >= 5 && hr < 11) list = menu.morning;
    else if(hr >= 11 && hr < 17) list = menu.noon;
    else if(hr >= 22 || hr < 5) list = menu.midnight;

    const item = list[Math.floor(Math.random()*list.length)];
    document.getElementById('food-cn').innerText = item.cn;
    document.getElementById('food-en').innerText = item.en;
    document.getElementById('food-cn').style.opacity = 1;
    document.getElementById('food-en').style.opacity = 1;
  }

  update();
</script>
</body>
</html>
